# Miyabi 作業ログ

このファイルはmiyabiとの作業履歴を記録します。新しいセッションで過去の文脈を引き継ぐために使用されます。

---

## 2025-12-22

### セッション 1

#### 指示
- 実装状況を確認

#### 実施内容
- プロジェクト全体の実装状況を調査
- **結果**: 95%完成
  - フロントエンド（ダッシュボード、設定ページ）: 完成
  - API全エンドポイント: 完成
  - DB操作、Chatwork連携: 完成
  - タスク抽出: ルールベースで実装済み
  - Gemini AI: 実装済みだが未使用

#### 備考
- 本番環境で利用可能な状態
- Gemini AIへの切り替えは検討可能

---

### セッション 2

#### 指示
- miyabiとのやり取りをログに残したい（自動更新）

#### 実施内容
- `MIYABI_LOG.md` を作成（作業履歴記録用）
- `CLAUDE.md` にログ更新ルールを追加
  - セッション終了時に自動でログ更新
  - 指示・実施内容・備考の形式で記録

#### 備考
- ログはMarkdown形式（miyabiが読み込みやすい）
- CLAUDE.mdと同様にプロジェクトコンテキストとして自動読み込み

---

### セッション 3

#### 指示
- Microsoft Teams対応を追加
- 設定画面をメッセンジャーごとにタブ分け

#### 実施内容
1. **DBスキーマ拡張** (`lib/db.ts`)
   - `settings`: `teams_webhook_secret` カラム追加
   - `rooms`, `tasks`: `source` カラム追加（'chatwork' | 'teams'）
   - 複合ユニーク制約 `(room_id, source)` 追加

2. **Teamsライブラリ作成** (`lib/teams.ts`) - 新規
   - HMAC-SHA256署名検証
   - @mention除去機能
   - ペイロード解析

3. **Teams Webhookエンドポイント** (`app/api/webhook/teams/route.ts`) - 新規
   - Outgoing Webhook対応
   - 5秒以内レスポンス

4. **設定API更新**
   - `app/api/settings/route.ts`: Teams設定対応
   - `app/api/rooms/route.ts`: ソース別取得、手動登録、削除API追加

5. **設定画面タブ化** (`app/settings/page.tsx`)
   - Chatwork / Teams タブ切り替え
   - Teams: Webhookシークレット設定、チャネル手動登録

6. **ダッシュボード更新** (`app/page.tsx`)
   - ソースバッジ表示（CW: 緑、Teams: 紫）

#### 備考
- Teamsチャネルは手動登録方式（APIで一覧取得不可のため）
- ビルド成功確認済み
- デプロイ後、DB初期化が必要（新カラム追加のため）

---

### セッション 4

#### 指示
- Teams連携の動作確認とバグ修正

#### 実施内容
1. **conversation ID正規化** - `;messageid=xxx`を除去してチャネル照合
2. **重複タスク防止** - `message_id`で重複チェック追加
3. **HTMLタグ除去** - `<p>`タグ等を除去、エンティティデコード
4. **Bot返信メッセージ設定** - 登録完了メッセージ + ダッシュボードリンク

#### 備考
- Teams Outgoing Webhookは返信必須（完全無効化不可）
- 個人アカウントではOutgoing Webhook使用不可（組織アカウント必要）
- 動作確認完了

---

<!--
使い方:
- 新しいセッションごとに「### セッション N」を追加
- 「#### 指示」にユーザーからの依頼を記録
- 「#### 実施内容」にmiyabiが行った作業を記録
- 「#### 備考」に重要な決定事項や注意点を記録
-->
